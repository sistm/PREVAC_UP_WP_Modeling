# ----------------------- #
# OBJECTIVE: Code analyzing results generated by the file "Simulation_results_Ad26.R", for the vaccine strategy Ad26/MVA
# Date (last update): 03/09/2023
# Author: Marie Alexandre

# Description: This file is built in 2 parts:
#                1) Analysis of the results regarding the time requested to reach a given threshold
#                2) Analysis of the results regarding the probability to reach a given Ab threshold at day 365
# ----------------------- #



rm(list=ls())


# ----- LIBRARIES ----- #
library(plyr)   # library for the function ddply
library(dplyr)  # library for the function case_when
# Libraries for plots
library(ggplot2) ; library(lemon) ;  library(scales)
# --------------------- #





# ****************************************** ####
#       PART 1: Analysis of the time to reach a threshold        ####
# **************************************** ####


# -- Information about results generated by the file "Simulation_results_Ad26.R" ####
Folder_results <- "Rcode/Results/Ad26_2"   # Folder in which results were saved
Nb_simulation <- 2000
Ab_thresholds <- seq(100,5000,by=100)


# -- Analysis of results ####
# Extraction of results (it can take time)
Estimated_time <- NULL
for(n in 1:Nb_simulation){
  # n <- 1
  if(n %% 100 == 0){print(n)}
  results <- read.table(file=paste(Folder_results,paste("Ad26_Time_Simu",n,".csv",sep=""),sep="/"),header=TRUE,sep="\t",dec=".")  
  Estimated_time <- rbind(Estimated_time,results)
}
Estimated_time$Ab_thresh <- 10^Estimated_time$Ab_thresh

# Calculation of distributions
Distribution_estimated_time <- ddply(.data=Estimated_time,.variables = .(ARM,CATAGE,Ab_thresh),summarise,
                                     Mean=mean(Time+90,na.rm=TRUE),
                                     Median=median(Time+90,na.rm=TRUE),
                                     # 95% Confidence interval
                                     ICMIN=quantile(Time+90,probs=c(0.025),na.rm=TRUE),
                                     ICMAX=quantile(Time+90,probs=c(0.975),na.rm=TRUE))

# Results' formatting
Distribution_estimated_time$Results <- paste0(round(Distribution_estimated_time$Mean,digits=0)," [",
                                              round(Distribution_estimated_time$ICMIN,digits=0)," ; ",
                                              round(Distribution_estimated_time$ICMAX,digits=0),"]",sep="")




# -- Plot of results ####
color_axis <- data.frame(x=unique(sort(c(100,200,600,1000,seq(500,5000,by=500)))),color="black",stringsAsFactors = FALSE)
color_axis$color[which(color_axis$x %in% c(200,600,1000))] <- "red"

Plot_estimated_Time <- ggplot(data=subset(Distribution_estimated_time,ARM==1)) +
  geom_vline(xintercept = c(200,600,1000),color="black",size=0.75,linetype="dashed") +
  geom_ribbon(aes(x=Ab_thresh,ymin=ICMIN,ymax=ICMAX,fill=as.factor(CATAGE),color=as.factor(CATAGE)),alpha=0.15,linetype="dotted",size=0.5) +
  geom_line(aes(x=Ab_thresh,y=Mean,color=as.factor(CATAGE)),size=1) +
  
  geom_hline(yintercept=90,linetype="dotted",color="gray40") +
  
  scale_x_continuous(name="Antibody anti GP-EBOV concentration threshold",breaks=color_axis$x) +
  scale_y_continuous(name="Time from the 1st injection required for 50% of the population \ndropping below antibody threshold (in days)",breaks=seq(0,4000,by=250)) + 
  
  scale_color_manual(name="Age",breaks=c("1-4","5-11","12-17","Adults"),labels=c("1-4 years","5-11 years","12-17 years","Adults"),values=hue_pal()(4)) + 
  scale_fill_manual(name="Age",breaks=c("1-4","5-11","12-17","Adults"),labels=c("1-4 years","5-11 years","12-17 years","Adults"),values=hue_pal()(4)) +
  coord_cartesian(ylim=c(0,2500),xlim=c(100,5010),expand = 0) +
  
  theme(panel.background = element_rect(fill="white"),
        axis.line = element_line(color="black",size=1.2),
        axis.text.y =  element_text(color="black",size=9,face="bold"),
        axis.text.x =  element_text(color=color_axis$color,size=9,face="bold"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(color="black",size=10,face="bold"),
        axis.title.y =element_text(color="black",size=10,face="bold"),
        legend.background = element_rect(color="white",size=0.8),
        legend.title = element_text(color="black",size=9,face="bold"),
        legend.text = element_text(color="black",face="italic",size=10),
        legend.key.width = unit(1,"cm"), legend.key.height = unit(0.5,"cm"),
        legend.key = element_rect(color="white",fill="white",size=0.5),
        strip.background = element_rect(fill="white",color="white"),
        strip.text = element_text(color="black",size=10,face="bold"),
        panel.spacing.x=unit(0, "lines"),
        legend.position = c(0.8,0.8),
        legend.direction = "vertical",
        legend.justification = "center",
        legend.box = "vertical",
        plot.title = element_text(size=13,hjust=0.5))
ggsave(Plot_estimated_Time,filename = paste("Data","Ad26_Time_Vs_AbThres_2000simu_7500Subj.png",sep="/"),height = 6,width=12)






# ****************************************** ####
#       PART 2: Analysis of the proba to reach a thresholdat day 365 ####
# **************************************** ####
# CATAGE: 1 = adults, 2 = 1-4y, 3 = 12-17y, 4 = 5-11y  

# -- Information about results generated by the file "Simulation_results_rvsv.R" ####
Folder_results <- "Rcode/Results/Ad26_2"   # Folder iin which results were saved
Nb_simulation <- 2000
Ab_thresholds <- seq(100,5000,by=100)


# -- Analysis of results ####
# Extraction of results (it can take time)
Estimated_Proba <- NULL
for(n in 1:Nb_simulation){
  # n <- 1
  if(n %% 100 == 0){print(n)}
  tmp_results <- read.table(file=paste(Folder_results,paste("Ad26MVA_proba_Simu",n,".csv",sep=""),sep="/"),header=TRUE,sep="\t",dec=".")  
  results <- do.call("rbind",lapply(tmp_results$Probability_results,function(list) cbind(as.data.frame(eval(parse(text=list))),Simu=n)))
  Estimated_Proba <- rbind(Estimated_Proba,results)
}
# we have to redefine categories
Estimated_Proba$CATAGE <- case_when(Estimated_Proba$CATAGE == 1 ~ "Adults",
                                    Estimated_Proba$CATAGE == 2 ~ "1-4",
                                    Estimated_Proba$CATAGE == 3 ~ "12-17",
                                    Estimated_Proba$CATAGE == 4 ~ "5-11")



# Calculation of distributions
Distribution_estimated_proba <- ddply(.data=Estimated_Proba,.variables = .(ARM,CATAGE,Ab_thresh),summarise,
                                      Mean=mean(Proba_D365,na.rm=TRUE),Median=median(Proba_D365,na.rm=TRUE),
                                      # 95% Confidence interval
                                      ICMIN=quantile(Proba_D365,na.rm=TRUE,probs=c(0.025)),
                                      ICMAX=quantile(Proba_D365,na.rm=TRUE,probs=c(0.975)))

# Results' formatting
Distribution_estimated_proba$Results <- paste0(round(Distribution_estimated_proba$Mean,digits=2)," [",
                                               round(Distribution_estimated_proba$ICMIN,digits=2)," ; ",
                                               round(Distribution_estimated_proba$ICMAX,digits=2),"]",sep="")


# -- Plot of results ####
color_axis <- data.frame(x=unique(sort(c(200,600,1000,seq(0,5000,by=500)))),color="black",stringsAsFactors = FALSE)
color_axis$color[which(color_axis$x %in% c(200,600,1000))] <- "red"

Plot_estimated_Proba <- ggplot(data=Distribution_estimated_proba) +
  geom_vline(xintercept = c(200,600,1000),color="black",size=0.75,linetype="dashed") +
  geom_ribbon(aes(x=Ab_thresh,ymin=ICMIN,ymax=ICMAX,fill=as.factor(CATAGE),color=as.factor(CATAGE)),alpha=0.3,linetype="dotted",size=0.5) + 
  geom_line(aes(x=Ab_thresh,y=Mean,color=as.factor(CATAGE)),size=1) +
  
  scale_x_continuous(name="Antibody threshold",breaks=color_axis$x) +
  scale_y_continuous(name="Probability (D365)",breaks=seq(0,1,by=0.2)) + 
  
  scale_color_manual(name="Age",breaks=c("1-4","5-11","12-17","Adults"),labels=c("1-4 years","5-11 years","12-17 years","Adults"),values=hue_pal()(4)) + 
  scale_fill_manual(name="Age",breaks=c("1-4","5-11","12-17","Adults"),labels=c("1-4 years","5-11 years","12-17 years","Adults"),values=hue_pal()(4)) + 
  
  coord_cartesian(ylim=c(0,1),xlim=c(0,5050),expand = 0) +
  
  theme(panel.background = element_rect(fill="white"),
        axis.line = element_line(color="black",size=1.2),
        axis.text.y =  element_text(color="black",size=9,face="bold"),
        axis.text.x =  element_text(color=color_axis$color,size=9,face="bold"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(color="black",size=10,face="bold"),
        axis.title.y =element_text(color="black",size=10,face="bold"),
        legend.background = element_rect(color="white",size=0.8),
        legend.title = element_text(color="black",size=9,face="bold"),
        legend.text = element_text(color="black",face="italic",size=10),
        legend.key.width = unit(1,"cm"), legend.key.height = unit(0.5,"cm"),
        legend.key = element_rect(color="white",fill="white",size=0.5),
        strip.background = element_rect(fill="white",color="white"),
        strip.text = element_text(color="black",size=10),
        panel.spacing.x=unit(0, "lines"),
        legend.position = c(0.8,0.7),
        legend.direction = "vertical",
        legend.justification = "center",
        legend.box = "vertical",
        plot.title = element_text(size=13,hjust=0.5))
ggsave(Plot_estimated_Proba,filename = paste("Data","Ad26_Proba_Vs_AbThres_2000simu_7500Subj.png",sep="/"),height = 8,width=12)

